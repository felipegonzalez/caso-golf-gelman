---
title: "Modelos para putts de golf"
output: html_notebook
bibliography: 
 - "../referencias/referencias.bib"
---


Este caso está basado en  @GelmanNolan y @GolfCase.
Usamos el flujo de trabajo bayesiano tomado del
documento de Michael Betancourt @BetancourtCase.


```{r}
library(cmdstanr)
library(posterior)
library(tidyverse)
source("../R/simular_resumenes.R")
```

## Problema

Queremos entender modelar la probabilidad de éxito de putts de Golf (putts: tiros
relativamente cerca del hoyo que buscan que la pelota ruede al hoyo o muy 
cerca de él), y cómo depende el éxito de la distancia del tiro. Quisiéramos
inferir qué tan precisos son los profesionales en sus tiros.

### Análisis conceptual

Podemos pensar en cada intento que hace un golfista como una prueba independiente
que puede resultar en éxito o fracaso. La probabilidad de éxito depende
de la distancia.

El problema es considerablemente complicado conceptualmente (@HolmesGolf, @PennerPutting)
si consideramos todas las fuentes de variación: ángulo de tiro, potencia de tiro,
declive en greens y así sucesivamente. 
Los supuestos que debemos criticar son:

Seguiremos haciendo la simplificación de superficie plana, pero consideramos
dos parámetros para el tiro con distintas condiciones de éxito:

1. El ángulo del tiro
2. La velocidad con la que la pelota llega (o no llega) al hoyo


El diámetro de una pelota de golf y el hoyo (en centrímetos) es de

```{r}
diam_pelota <- (1.68 * 2.54) %>% round(1)
diam_hoyo <- (4.25 * 2.54) %>% round(1)
c(diam_pelota, diam_hoyo)
```

Supondremos por el momento que los greens de golf (áreas cerca del hoyo) 
son perfectamente planos (lo cual no es cierto, pero refinaremos después),
de modo que el éxito depende de 

1. Tirar la pelota con un ángulo suficientemente cercano
a cero con
respecto a la línea que va del centro de la pelota al centro del hoyo.
2. Tirar la pelota con una velocidad suficiente para llegue al hoyo pero
no tan alta que vuele por encima del hoyo.

Mejores datos de los tipos de fallo sería útil, pero por el momento no 
consideramos que estén disponibles.

#### Ángulo de tiro

Supongamos que la distancia del centro de la pelota al centro del hoyo es $x$, y que 
$\theta$ es el ángulo del tiro con respecto a la recta que va del centro de la pelota
al centro del hoyo. El tiro es exitoso cuando

$$\tan(\theta) < \frac{R - r}{2x}$$
Por simetría, sólo consideramos $\theta$ con valores positivos (aunque puede
ser que algunos golfistas tengan fallas asimétricas, eso lo discutimos más adelante).

![Tiro de golf](imagenes/golf-put.png)
En particular para nuestro problema, la condición de éxito es

$$\tan(\theta) < \frac{3.25}{x}$$

Mejores golfistas tendrán mejor control sobre $\theta > 0$, y conforme
$x$ es más grande, la probabilidad de tener éxito baja:

```{r}
tibble(x = seq(20, 500, 1)) %>% 
  mutate(theta = (180 / pi) * atan(3.25 / x)) %>% 
ggplot(aes(x, theta)) + geom_point() +
  xlab("Distancia (cm)") +
  ylab(expression(paste("Desviación máxima ", theta))) +
  labs(subtitle = "Desviación máxima permitida para tener éxito a distintas distancias")
```

- Esta curva puede variar dependiendo del jugador, pero vamos a modelar el conjunto
de tiros de profesionales. Suponemos homogeneidad que podríamos checar con
datos desagregados por jugador. Estos datos podrían tener sobrerrepresentación
de tiradores malos (que quizá hacen más tiros).

#### Velocidad final

Siguiendo
 [@PennerPutting], existe un rango de velocidades iniciales que determinan la condición
 de éxito.


- La condición de éxito en un tiro recto es que la velocidad final $v_f$ (en metros por segundo)
de la pelota cumpla
$$0 < v_f < 1.63$$
- La aceleración de la pelota al rodar en el green:
$$a = (10/7)\frac{\rho}{r}g$$
dond $\rho$ depende de la superficie donde rueda la pelota. Datos experimentales
indican que la media en greens es de $\rho = 0.131, con un rango de 0.065 a 0.196.
- Tomaremos $\rho = 0.131$

La velocidad inicial de la pelota en términos de la velocidad inicial, usando esta aceleración, es
$$v_f^2 = v_0^2 - (10/7)\frac{\rho}{r}gx = v_0^2 - (10/7)\frac{\rho}{4.3}9.8x=v_0^2 - 3.26\rho x$$
donde $x$ es la distancia de la pelota al hoyo. Ahora podemos despejar para calcular
las condiciones de éxito sobre la velocidad inicial $v_0$:

$$d < v_0^2 < 1.63 + d$$

donde $d = 3.26\rho x$. La condición de éxito es entonces

$$3.26\rho x < v_0^2 < 1.63 + 3.26\rho x$$



### Espacio de observaciones

Usaremos datos de tiros de profesionales que incluyen la distancia al hoyo
y si el tiro fue exitoso o no.

El espacio de observaciones que esperamos del tipo $(x, y)$ donde $x$ es la
distancia del putt y $y$ indica si se logró o no. Probablemente tendremos
los datos agregados: para cada distancia aproximada $x$ tendremos un conteo
de intentos y éxitos sobre los tiros de los jugadores profesionales.

```{bash}
sed -n '/^data/,/\}/p' ../stan/modelo.stan
```

### Estadísticas resumen

Consideraremos el porcentaje de éxitos para cada distancia dada en las observaciones
(cada cubeta de distancias) como resumen principal de interés. 

```{bash}
sed -n '/^transformed/,/\}/p' ../stan/modelo.stan
```

### Desarrollo del modelo

Consideraremos que las observaciones del número de éxitos $e(x)$ a una 
distancia de $x$ metros es

$$e(x) \sim \textrm{Binom}(n(x), p(x))$$
 La probabilidad de éxito depende de los ángulos
y la velocidad inicial que se observen en los tiros. Comenzaremos suponiendo que
la probabilidad de éxito es el producto de la probabilidad de usar el ángulo
en el rango de éxito, por la probablilidad de usar una velocidad inicial en el
rango de éxito:

$$p(x) = p_{ang}(x)p_{dist}(x)$$

Empezamos poniendo

$$\theta \sim N^+(0,\sigma_a),$$
que expresa nuestra incertidumbre acerca de la desviación promedio $\theta$ que logran
los jugadores profesionales. La probabilidad de éxito es entonces

$$p_{ang}(x) = P(\tan(\theta) < 3.25/x) = P(\theta < \arctan(3.25/x))$$
De modo que 
$$p_{ang}(x) = P \left (Z^+ <  \frac{\arctan(3.25/x)}{\sigma_a}\right )$$
y entonces

$$p_{ang}(x)= 2\Phi \left(\frac{\arctan(3.25/x)}{\sigma_a}\right ) - 1$$
donde $\Phi$ es la distribución acumulada de la normal estándar.

Ahora: no conocemos el valor de $\sigma_a$, así que tenemos que poner
alguna información acerca de este valor para el cual no tendremos mediciones.
En este punto es necesario consultar con algún experto.

Un experto nos informa que es raro los tiradores profesionales rara vez
exceden más de 4 grados a partir de la línea que quieren tirar, y sabemos
que la desviación promedio no puede ser muy cercana a cero, pues siempre
existen fallas, especialmente más allá de 1 metro de distancia. Una desviación estándar
de los tiros debería estar entre 0.5 y 2.5, por ejemplo. Por el momento
no consideramos que esto pueda variar en función de la distancia. Así que
ponemos 
$$\sigma_A \sim Gamma(a, b)$$
y tenemos que establecer $a,b$ de forma la mayor parte de la probabilidad
esté entre 0.1 grados y 3 grados de desviación

```{r, fig.width=4, fig.height=2.5}
set.seed(11882)
qplot((180 / pi) * rgamma(5000, 15, 500))
qgamma(c(0.01, 0.99), 15, 500) * (180/pi)
```


Ahora es necesario incluir la información de la velocidad inicial y poner
supuestos de cómo tiran los jugadores de golf. Un supuesto que podemos hacer
es que los jugadores intentan tirar un poco más allá del hoyo, de forma
que la pelota entre con cierta velocidad, por ejemplo, tomando el promedio
de los extremos de éxito, podemos poner
$$v_0^2 = (0.82 + 3.26\rho x)(1 + u)$$
donde $u$ es una variable normal con media cero y desviación estándar $\sigma_{d}$
chica:
$$u \sim N(0, \sigma_{d})$$

Estamos suponiendo que el error es multiplicativo con respecto al momento
que se imparte a la pelota (ver @GolfCase para la idea general).

Según este supuesto, la probabilidad de éxito en términos de la velocidad inicial es

$$2\Phi \left(\frac{0.82}{\sigma_{d} (0.82 + 3.26\rho x)}\right) - 1$$
Para poner una inicial consistente con conocimiento de dominio podemos
calcular la distancia que recorrería la pelota bajo distintos supuestos si no
hubiera hoyo. La distancia total recorrida, por los supuestos de arriba, es:

```{r}
sim_dist_recorrida <- function(x, rho, sigma_dist){
  u <- rnorm(100, 0, sigma_dist)
  dist_recorrida  <- (0.82 + 3.26 * rho * x) * (1 + u) / (3.26 * rho)
  error <- dist_recorrida / x
  error
}
sim_1 <- sim_dist_recorrida(500, 0.131, 0.01) * 500
quantile(sim_1) 
```

Que se ve como sigue para un valor de $\sigma_{dist} = 0.005$ (1% de error)

```{r}
sigma_dist <- 0.005
tibble(x = seq(10, 600, 10)) %>% 
  mutate(prob_exito = 2*pnorm(0.82 / (sigma_dist * (0.82 + 3.26*(0.131)*x))) - 1) %>% 
ggplot(aes(x = x, y = prob_exito)) + geom_point()
```

Finalmente, ponemos una distribución inicial para $\sigma_d$. Esta cantidad
puede ser más difícil de elicitar en un experto, pero podemos hacer simulaciones
para ver las consecuencias de nuestras decisiones. Comenzaremos poniendo

$$\sigma_{dist} \sim Gamma(5, 1000)$$
```{r}
2*c(qgamma(0.01, 5, 1000), qgamma(0.99, 5, 1000)) %>% round(4)
```
Es decir, que el error en este tipo de tiros va en general entre 0.2% y 2%.


Hemos incluido información acerca del problema:

- El modelo de las observaciones y los mecanismos subyacentes
- Distribuciones iniciales consistentes con el conocimiento que tenemos acerca 
del proceso.

### Simular ensamble bayesiano

Ahora simulamos el ensamble bayesiano. Escogemos algunas distancias
en centímetros y un número de intentos a cada distancia. Esperamos
encontrar menos tiros a distancias más grandes. Si este fuera un experimento
diseñado, quizá tendríamos el número de intentos en cada distancia predefinidos.
Aunque no es ideal, en este caso pondremos algunos números de intentos y distancias hipotéticas
para probar nuestros modelos.

```{r}
sim_datos <- jsonlite::read_json("../datos/datos_prueba.json", simplifyVector = TRUE)
parametros <- jsonlite::read_json("../datos/datos_inicial.json", simplifyVector = TRUE)
print(sim_datos)
```


```{r}
sim_ensemble_datos <- c(sim_datos, parametros)
ruta <- file.path("../stan/simular_ensemble_modelo.stan")
modelo_inicial <- cmdstan_model(ruta)
ensemble <- simular_ensemble(modelo_inicial, sim_ensemble_datos)
```

Y examinamos las siguientes probabilidades de éxito:

```{r}
exitos_tbl <- curvas_exito(ensemble, sim_ensemble_datos)
 g_1 <- ggplot(exitos_tbl, aes(x = factor(x), y = prop_exitos)) +
    geom_jitter(alpha = 0.1) 
g_1
```

En este punto podemos consultar con el experto para verificar que:

- Pŕacticamente no consideramos realizaciones imposibles (por ejemplo, 100% de éxito para todas las distancias, 50% de éxitos para tiros de 50 cm, etc.)
- El espacio de realizaciones cubre apropiadamente el rango de posibilidades
que el experto considera factible.

### Ajustar al ensemble simulado

Ahora probamos ajustar el modelo a las simulaciones. En este paso tenemos
qué checar qué puede pasar incluso con las condiciones más extremas 
que creemos que podemos encontrar. 

Podemos probar con una simulación:

```{r}
num_iter <- 11
exitos_sim <- ensemble$draws("exitos")
sigma_sim_tbl <- ensemble$draws(c("sigma_ang", "sigma_dist")) %>% as_draws_df()
```


```{r}
ruta <- file.path("../stan/modelo.stan")
modelo <- cmdstan_model(ruta)
```


```{r, message=FALSE, warning=FALSE}
datos_1 <- c(sim_ensemble_datos, list("exitos_obs" = exitos_sim[num_iter, 1, ] %>% as.numeric))
ajuste <- ajustar_modelo(modelo, datos_1, iter_sampling=2000)
```

```{r}
ajuste$cmdstan_diagnose()
```

Este ajuste tuvo problemas. Observamos que tenemos multimodalidad en nuestra posterior:

```{r}
ajuste_draw <- ajuste$draws(c("sigma_dist", "sigma_ang")) %>% as_draws_df
ggplot(ajuste_draw, aes(x = sigma_ang, y = sigma_dist)) + geom_point() +
  geom_point(data = sigma_sim_tbl[num_iter, ], colour = "red")
```
Esto sucede porque hay dos maneras de ajustar los datos: los errores de ángulo
son los más importantes, o los errores de distancia son los más importantes. 
Nuestras información inicial no restringe adecuadamente la posterior hacia ninguna
de estas dos posibilidades.


